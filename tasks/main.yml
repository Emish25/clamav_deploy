---
# ============================================================================
# INSTALLATION DE CLAMAV
# ============================================================================

- name: "ğŸ“¦ Mise Ã  jour du cache APT"
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: install

- name: "ğŸ›¡ï¸ Installation de ClamAV et composants"
  apt:
    name:
      - clamav
      - clamav-daemon
      - clamav-freshclam
    state: present
  tags: install

# ============================================================================
# CRÃ‰ATION DES RÃ‰PERTOIRES
# ============================================================================

- name: "ğŸ“ CrÃ©ation du rÃ©pertoire de scripts"
  file:
    path: /opt/clamav-automation/scripts
    state: directory
    mode: '0755'
    owner: root
    group: root
  tags: config

- name: "ğŸ“ CrÃ©ation du rÃ©pertoire de logs"
  file:
    path: /var/log/clamav
    state: directory
    mode: '0755'
    owner: root
    group: root
  tags: config

# ============================================================================
# COPIE DES SCRIPTS
# ============================================================================

- name: "ğŸ“¤ Copie du script de scan"
  copy:
    src: clamav_scan.sh
    dest: /opt/clamav-automation/scripts/clamav_scan.sh
    mode: '0755'
    owner: root
    group: root
  tags: scripts

- name: "ğŸ“¤ Copie du script de mise Ã  jour"
  copy:
    src: clamav_update.sh
    dest: /opt/clamav-automation/scripts/clamav_update.sh
    mode: '0755'
    owner: root
    group: root
  tags: scripts

# ============================================================================
# CONFIGURATION SSH POUR REPORTING
# ============================================================================

- name: "ğŸ”‘ GÃ©nÃ©ration de la clÃ© SSH pour reporting (si inexistante)"
  command: ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519_reporting -N ""
  args:
    creates: /root/.ssh/id_ed25519_reporting
  tags: ssh

- name: "ğŸ“‹ RÃ©cupÃ©ration de la clÃ© publique"
  slurp:
    src: /root/.ssh/id_ed25519_reporting.pub
  register: ssh_public_key
  tags: ssh

- name: "ğŸ”§ Configuration SSH pour le serveur central"
  blockinfile:
    path: /root/.ssh/config
    create: yes
    mode: '0600'
    block: |
      Host {{ central_server }}
        IdentityFile /root/.ssh/id_ed25519_reporting
        StrictHostKeyChecking no
        UserKnownHostsFile=/dev/null
  tags: ssh

- name: "ğŸ“ Affichage de la clÃ© publique Ã  ajouter sur le serveur central"
  debug:
    msg: 
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "ğŸ”‘ CLÃ‰ PUBLIQUE Ã€ AJOUTER SUR LE SERVEUR CENTRAL"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "{{ ssh_public_key.content | b64decode }}"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "ğŸ“Œ Ajoutez cette clÃ© dans /home/ansible/.ssh/authorized_keys"
      - "   sur le serveur {{ central_server }}"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  tags: ssh

# ============================================================================
# INSTALLATION DES CRON JOBS
# ============================================================================

- name: "â° Installation du fichier cron depuis template"
  template:
    src: clamav-cron.j2
    dest: /etc/cron.d/clamav-automation
    mode: '0644'
    owner: root
    group: root
  tags: cron

# ============================================================================
# PREMIÃˆRE MISE Ã€ JOUR DES SIGNATURES
# ============================================================================

- name: "ğŸ”„ ArrÃªt du service freshclam avant mise Ã  jour manuelle"
  systemd:
    name: clamav-freshclam
    state: stopped
  ignore_errors: yes
  tags: update

- name: "ğŸ“¥ PremiÃ¨re mise Ã  jour des signatures ClamAV"
  command: /opt/clamav-automation/scripts/clamav_update.sh
  register: update_result
  ignore_errors: yes
  tags: update

- name: "ğŸ”„ RedÃ©marrage du service freshclam"
  systemd:
    name: clamav-freshclam
    state: started
    enabled: yes
  ignore_errors: yes
  tags: update

# ============================================================================
# AFFICHAGE DU RÃ‰SUMÃ‰
# ============================================================================

- name: "âœ… RÃ©sumÃ© de l'installation"
  debug:
    msg:
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "âœ… ClamAV installÃ© et configurÃ© avec succÃ¨s sur {{ ansible_hostname }}"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "ğŸ“‚ Scripts : /opt/clamav-automation/scripts/"
      - "ğŸ“ Logs : /var/log/clamav/"
      - "ğŸ›¡ï¸ Scan : Samedi Ã  {{ scan_schedule_hour }}h00"
      - "ğŸ”„ Mise Ã  jour : Dimanche Ã  {{ update_schedule_hour }}h00"
      - "ğŸ“Š Reporting : {{ central_server }}"
      - "ğŸ–¥ï¸  IP : {{ ansible_default_ipv4.address }}"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  tags: always
